name: Test Messaging API Configuration

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨

jobs:
  test-messaging-api:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check LINE_CHANNEL_ACCESS_TOKEN
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        run: |
          if [ -z "$LINE_CHANNEL_ACCESS_TOKEN" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: LINE_CHANNEL_ACCESS_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "GitHub Settings â†’ Secrets and variables â†’ Actions ã§è¨­å®šã—ã¦ãã ã•ã„"
            exit 1
          else
            echo "âœ… LINE_CHANNEL_ACCESS_TOKEN ã¯æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
            echo "ãƒˆãƒ¼ã‚¯ãƒ³é•·: ${#LINE_CHANNEL_ACCESS_TOKEN} æ–‡å­—"
          fi

      - name: Check LINE_TARGET_USER_ID
        env:
          LINE_TARGET_USER_ID: ${{ secrets.LINE_TARGET_USER_ID }}
        run: |
          if [ -z "$LINE_TARGET_USER_ID" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: LINE_TARGET_USER_ID ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            echo "GitHub Settings â†’ Secrets and variables â†’ Actions ã§è¨­å®šã—ã¦ãã ã•ã„"
            exit 1
          else
            echo "âœ… LINE_TARGET_USER_ID ã¯æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã™"
            echo "User ID: ${LINE_TARGET_USER_ID:0:10}..."
          fi

      - name: Test Messaging API connection
        env:
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          LINE_TARGET_USER_ID: ${{ secrets.LINE_TARGET_USER_ID }}
        run: |
          cd src
          python3 << 'PYTHON_SCRIPT'
import os
import sys
from datetime import datetime

# notify_line.pyã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãƒ†ã‚¹ãƒˆé€ä¿¡
sys.path.insert(0, '.')
from notify_line import send_line_notify

token = os.environ.get('LINE_CHANNEL_ACCESS_TOKEN')
user_id = os.environ.get('LINE_TARGET_USER_ID')

if not token:
    print("âŒ ãƒˆãƒ¼ã‚¯ãƒ³ãŒç’°å¢ƒå¤‰æ•°ã«ã‚ã‚Šã¾ã›ã‚“")
    sys.exit(1)

if not user_id:
    print("âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒç’°å¢ƒå¤‰æ•°ã«ã‚ã‚Šã¾ã›ã‚“")
    sys.exit(1)

# ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
now = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
message = f"""
ğŸ”” Messaging API è¨­å®šãƒ†ã‚¹ãƒˆ

âœ… LINE_CHANNEL_ACCESS_TOKEN ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã™
âœ… LINE_TARGET_USER_ID ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã™

ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå±Šã‘ã°ã€é€šçŸ¥æ©Ÿèƒ½ã¯æ­£å¸¸ã§ã™ã€‚

ğŸ“… ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ—¥æ™‚: {now}
ğŸ¤– å®Ÿè¡Œç’°å¢ƒ: GitHub Actions
"""

try:
    success = send_line_notify(message, token=token, user_id=user_id)
    if success:
        print("âœ… Messaging APIé€šçŸ¥ã®ãƒ†ã‚¹ãƒˆé€ä¿¡ã«æˆåŠŸã—ã¾ã—ãŸ")
        sys.exit(0)
    else:
        print("âŒ Messaging APIé€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ")
        sys.exit(1)
except Exception as e:
    print(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
    sys.exit(1)
PYTHON_SCRIPT
