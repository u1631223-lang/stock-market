# Ticket #6: notify_line.py å®Ÿè£…

## ğŸ“‹ åŸºæœ¬æƒ…å ±

- **å„ªå…ˆåº¦:** ğŸŸ¡ ä¸­
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:** âœ… å®Œäº†ï¼ˆMessaging APIç§»è¡Œæ¸ˆã¿: 2025-10-21ï¼‰
- **æ¨å®šå·¥æ•°:** 45åˆ†
- **ä¾å­˜é–¢ä¿‚:** #1
- **æ‹…å½“è€…:** Claude
- **ä½œæˆæ—¥:** 2025-10-21
- **æœ€çµ‚æ›´æ–°:** 2025-10-21 08:22

---

## ğŸ“ æ¦‚è¦

LINE Notify APIã‚’ä½¿ç”¨ã—ã¦ã€ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°çµæœã®é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®Ÿè£…ã™ã‚‹ã€‚æˆåŠŸãƒ»å¤±æ•—ã®é€šçŸ¥ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ©Ÿèƒ½ã‚’æä¾›ã€‚

> **é‡è¦:** LINE Notify ã¯ 2025å¹´3æœˆ31æ—¥ã«æä¾›çµ‚äº†äºˆå®šã®ãŸã‚ã€Messaging API ã¸ã®ç§»è¡Œè¨ˆç”»ç«‹æ¡ˆã¨å®Ÿè£…ãŒè¿½åŠ ã‚¿ã‚¹ã‚¯ã¨ã—ã¦å¿…è¦ã§ã™ã€‚

---

## âœ… Messaging API ç§»è¡Œå®Œäº†ï¼ˆ2025-10-21ï¼‰

- [x] LINE Developers ã§å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨ Messaging API ãƒãƒ£ãƒãƒ«ã‚’ä½œæˆ
  - ãƒ—ãƒ­ãƒã‚¤ãƒ€: `stock-market`
  - Channel ID: `2008327755`
- [x] ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãƒ»User IDã®å–å¾—å®Œäº†
- [x] `notify_line.py` ã‚’ Messaging API ã® push ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã«å¯¾å¿œ
  - ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `https://api.line.me/v2/bot/message/push`
  - JSONå½¢å¼ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
- [x] GitHub Secrets ã®æ›´æ–°
  - `LINE_CHANNEL_ACCESS_TOKEN`: ãƒãƒ£ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³
  - `LINE_TARGET_USER_ID`: é€ä¿¡å…ˆUser ID
- [x] ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ»ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°å®Œäº†

---

## ğŸ¯ ã‚¿ã‚¹ã‚¯ä¸€è¦§

- [x] `src/notify_line.py` ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
- [x] `send_line_notify(message: str, token: str) -> bool` é–¢æ•°å®Ÿè£…
  - [x] ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ LINE_NOTIFY_TOKEN å–å¾—
  - [x] LINE Notify APIå‘¼ã³å‡ºã—
  - [x] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ç¢ºèª
  - [x] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- [x] `format_success_message(datetime_str: str, target: str, rankings: List[Dict]) -> str` é–¢æ•°å®Ÿè£…
  - [x] æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ
  - [x] ãƒ™ã‚¹ãƒˆ3ã®éŠ˜æŸ„è¡¨ç¤º
  - [x] è¦‹ã‚„ã™ã„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
- [x] `format_error_message(datetime_str: str, target: str, error: str) -> str` é–¢æ•°å®Ÿè£…
  - [x] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”Ÿæˆ
  - [x] ã‚¨ãƒ©ãƒ¼å†…å®¹ã®ç°¡æ½”ãªè¡¨ç¤º
- [x] ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å®Ÿè¡Œå¯¾å¿œï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
- [x] docstring è¿½åŠ 
- [x] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆ4ä»¶ã™ã¹ã¦æˆåŠŸï¼‰
- [x] ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆï¼ˆ2ä»¶ã™ã¹ã¦æˆåŠŸï¼‰

---

## ğŸ“¦ æˆæœç‰©

### ãƒ•ã‚¡ã‚¤ãƒ«: `src/notify_line.py`

**ä¸»è¦é–¢æ•°ã®ã‚·ã‚°ãƒãƒãƒ£:**

```python
import os
from typing import List, Dict

def send_line_notify(message: str, token: str = None) -> bool:
    """
    LINE Notify APIã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹

    Args:
        message: é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        token: LINE Notify ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆçœç•¥æ™‚ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ï¼‰

    Returns:
        bool: é€ä¿¡æˆåŠŸæ™‚ Trueã€å¤±æ•—æ™‚ False

    Raises:
        ValueError: ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆ
    """
    pass

def format_success_message(datetime_str: str, target: str, rankings: List[Dict]) -> str:
    """
    æˆåŠŸæ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹

    Args:
        datetime_str: æ—¥æ™‚æ–‡å­—åˆ—ï¼ˆä¾‹: "2025-10-20 09:15"ï¼‰
        target: "morning" or "afternoon"
        rankings: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®ãƒªã‚¹ãƒˆ

    Returns:
        str: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    """
    pass

def format_error_message(datetime_str: str, target: str, error: str) -> str:
    """
    ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹

    Args:
        datetime_str: æ—¥æ™‚æ–‡å­—åˆ—
        target: "morning" or "afternoon"
        error: ã‚¨ãƒ©ãƒ¼å†…å®¹

    Returns:
        str: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    """
    pass
```

---

## âœ… å®Œäº†æ¡ä»¶

- [x] `src/notify_line.py` ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹
- [x] ã™ã¹ã¦ã®é–¢æ•°ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [x] ç’°å¢ƒå¤‰æ•° `LINE_NOTIFY_TOKEN` ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ãã‚‹
- [x] LINE Notify APIå‘¼ã³å‡ºã—ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹
- [x] æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹
- [x] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã‚‹
- [x] ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å®Ÿè¡Œã§ãƒ†ã‚¹ãƒˆé€ä¿¡ã§ãã‚‹
- [x] docstring ãŒé©åˆ‡ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹
- [x] PEP 8 ã‚¹ã‚¿ã‚¤ãƒ«ã‚¬ã‚¤ãƒ‰ã«æº–æ‹ ã—ã¦ã„ã‚‹
- [x] ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ†ã‚¹ãƒˆæˆåŠŸï¼ˆ4ä»¶ï¼‰
- [x] ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆæˆåŠŸï¼ˆ2ä»¶ï¼‰

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### ç’°å¢ƒå¤‰æ•°è¨­å®š

```bash
# LINE Notify ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ï¼ˆhttps://notify-bot.line.me/ja/ï¼‰
export LINE_NOTIFY_TOKEN="your_token_here"
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# ä»®æƒ³ç’°å¢ƒã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
source venv/bin/activate

# ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
cd src
python notify_line.py
```

### é–¢æ•°å€‹åˆ¥ãƒ†ã‚¹ãƒˆ

```python
from notify_line import send_line_notify, format_success_message, format_error_message
import os

# ãƒˆãƒ¼ã‚¯ãƒ³ç¢ºèª
token = os.getenv("LINE_NOTIFY_TOKEN")
print(f"Token: {'è¨­å®šæ¸ˆã¿' if token else 'æœªè¨­å®š'}")

# æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆ
rankings = [
    {"rank": "1", "code": "1234", "name": "ã‚µãƒ³ãƒ—ãƒ«æ ªå¼"},
    {"rank": "2", "code": "5678", "name": "ãƒ†ã‚¹ãƒˆéŠ˜æŸ„"},
    {"rank": "3", "code": "9012", "name": "ãƒ‡ãƒ¢ä¼šç¤¾"},
]
success_msg = format_success_message("2025-10-21 09:15", "morning", rankings)
print(success_msg)

# ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ†ã‚¹ãƒˆ
error_msg = format_error_message("2025-10-21 09:15", "morning", "HTTP 403 Forbidden")
print(error_msg)

# å®Ÿéš›ã«é€ä¿¡ãƒ†ã‚¹ãƒˆ
send_line_notify("ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", token)
```

---

## ğŸ“Œ æ³¨æ„äº‹é …

- **ãƒˆãƒ¼ã‚¯ãƒ³ã®ç®¡ç†**: ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã€ã‚³ãƒ¼ãƒ‰ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ãªã„
- **GitHub Secrets**: GitHub Actions ã§ã¯ Secrets ã¨ã—ã¦è¨­å®š
- **APIåˆ¶é™**: LINE Notifyã«ã¯æ™‚é–“å½“ãŸã‚Šã®é€ä¿¡ä¸Šé™ãŒã‚ã‚‹ï¼ˆé€šå¸¸ã¯å•é¡Œãªã—ï¼‰
- **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é•·**: æœ€å¤§1,000æ–‡å­—ã¾ã§
- **æ”¹è¡Œ**: `\n` ã§æ”¹è¡Œå¯èƒ½

---

## ğŸ” å®Ÿè£…ä¾‹

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¾‹

**æˆåŠŸæ™‚:**
```
âœ… [æˆåŠŸ] 2025-10-21 09:15
æœãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—å®Œäº†

ğŸ“Š ãƒ™ã‚¹ãƒˆ3:
1ä½: ã‚µãƒ³ãƒ—ãƒ«æ ªå¼ (1234)
2ä½: ãƒ†ã‚¹ãƒˆéŠ˜æŸ„ (5678)
3ä½: ãƒ‡ãƒ¢ä¼šç¤¾ (9012)
```

**ã‚¨ãƒ©ãƒ¼æ™‚:**
```
âŒ [ã‚¨ãƒ©ãƒ¼] 2025-10-21 09:15
æœãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—å¤±æ•—

ã‚¨ãƒ©ãƒ¼å†…å®¹:
HTTP 403 Forbidden
```

### LINE Notify API å‘¼ã³å‡ºã—ä¾‹

```python
import requests
from config import LINE_NOTIFY_API

def send_line_notify(message: str, token: str = None) -> bool:
    if token is None:
        token = os.getenv("LINE_NOTIFY_TOKEN")

    if not token:
        raise ValueError("LINE_NOTIFY_TOKEN ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")

    headers = {"Authorization": f"Bearer {token}"}
    data = {"message": message}

    try:
        response = requests.post(LINE_NOTIFY_API, headers=headers, data=data, timeout=10)
        response.raise_for_status()
        return True
    except requests.exceptions.RequestException as e:
        print(f"LINEé€šçŸ¥é€ä¿¡ã‚¨ãƒ©ãƒ¼: {e}")
        return False
```

---

## ğŸ”— é–¢é€£ãƒã‚±ãƒƒãƒˆ

- **ä¾å­˜å…ƒ:** #1 (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç’°å¢ƒæ§‹ç¯‰)
- **é–¢é€£:** #4 (scrape_rankings.py) - ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹

---

## ğŸ“š å‚è€ƒè³‡æ–™

- [LINE Notify API Document](https://notify-bot.line.me/doc/ja/)
- [LINE Notify ãƒˆãƒ¼ã‚¯ãƒ³ç™ºè¡Œ](https://notify-bot.line.me/my/)

---

## ğŸ“ ä½œæ¥­ãƒ­ã‚°

| æ—¥æ™‚ | ä½œæ¥­å†…å®¹ | å‚™è€ƒ |
|------|---------|------|
| 2025-10-21 08:00 | ãƒã‚±ãƒƒãƒˆä½œæˆ | - |
| 2025-10-21 08:20 | notify_line.py ä½œæˆ | 3ã¤ã®ä¸»è¦é–¢æ•°å®Ÿè£… |
| 2025-10-21 08:20 | main()é–¢æ•°è¿½åŠ  | ãƒ†ã‚¹ãƒˆç”¨ã®ç›´æ¥å®Ÿè¡Œæ©Ÿèƒ½ |
| 2025-10-21 08:21 | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ†ã‚¹ãƒˆ | 4ä»¶ã®ãƒ†ã‚¹ãƒˆã™ã¹ã¦æˆåŠŸ |
| 2025-10-21 08:22 | ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ | 2ä»¶ã®ãƒ†ã‚¹ãƒˆã™ã¹ã¦æˆåŠŸ |
| 2025-10-21 08:22 | âœ… ãƒã‚±ãƒƒãƒˆå®Œäº† | ã™ã¹ã¦ã®ã‚¿ã‚¹ã‚¯å®Œäº† |
