# 松井証券ランキング自動取得システム - 要件定義

## 概要
松井証券のデイトレードランキングページから、指定された時刻に自動的にランキングデータを取得し、保存・通知するシステムを構築する。

## 目的
- 株式市場の取引時間中、定期的にランキング情報を収集
- データを蓄積して後から分析できるようにする
- 取得のタイミングをリアルタイムで通知

## 対象URL

### 1. 朝のランキング
- URL: `https://finance.matsui.co.jp/ranking-day-trading-morning/index?condition=0&market=0`
- 取得時刻: **09:15**, **09:30**, **12:00**

### 2. 午後のランキング
- URL: `https://finance.matsui.co.jp/ranking-day-trading-afternoon/index?condition=0&market=0`
- 取得時刻: **12:45**, **14:30**

## 機能要件

### 1. データ取得
- **対象**: ベスト10（上位10銘柄）
- **取得項目**: ページに表示されている全ての情報
  - 順位
  - 銘柄コード
  - 銘柄名
  - 株価関連情報
  - 出来高
  - 売買代金
  - その他の表示項目

### 2. 実行条件
- **実行日**: 平日のみ（土日祝日を除く）
- **休日判定**: jpholidayライブラリを使用
- **タイムゾーン**: 日本標準時（JST）

### 3. データ保存
- **形式**: JSON形式
- **保存先**: GitHubリポジトリ内
- **ディレクトリ構造**:
  ```
  data/
  ├── morning/
  │   ├── ranking_20251020_0915.json
  │   ├── ranking_20251020_0930.json
  │   └── ranking_20251020_1200.json
  └── afternoon/
      ├── ranking_20251020_1245.json
      └── ranking_20251020_1430.json
  ```
- **ファイル命名規則**: `ranking_YYYYMMDD_HHMM.json`

### 4. 通知
- **手段**: LINE Notify（2025/03/31まで）→ LINE Messaging API へ移行予定
- **通知内容**:
  - 取得成功時: 「[成功] {日時} {朝/午後}ランキング取得完了」
  - 取得失敗時: 「[エラー] {日時} {朝/午後}ランキング取得失敗: {エラー内容}」
  - 休日スキップ時: 通知なし

### 5. 実行環境
- **プラットフォーム**: GitHub Actions
- **スケジュール**: cron形式で5つの時刻を指定
- **手動実行**: workflow_dispatch でも実行可能

## 非機能要件

### 1. 信頼性
- ネットワークエラー時のリトライ処理（最大3回）
- タイムアウト設定（30秒）
- エラーログの記録

### 2. パフォーマンス
- 各実行は5分以内に完了
- サーバーへの負荷を最小限に（適切な間隔での実行）

### 3. セキュリティ
- LINE Notify トークンはGitHub Secretsで管理（移行後は Messaging API のチャネルアクセストークンを管理）
- 認証情報をコードにハードコードしない

### 4. メンテナンス性
- コードの可読性を重視
- 設定値は定数として管理
- HTML構造変更時の修正が容易な設計

## 技術スタック

### 言語・ライブラリ
- **Python 3.11+**
- **requests**: HTTPリクエスト（User-Agent設定対応）
- **beautifulsoup4**: HTMLパース
- **lxml**: 高速HTMLパーサー
- **jpholiday**: 日本の祝日判定

### インフラ
- **GitHub Actions**: 定時実行基盤
- **GitHub Repository**: データストレージ

### 外部サービス
- **LINE Messaging API**: LINE公式アカウントから通知を送るためのAPI（現状は LINE Notify を継続利用）

## スクレイピング対策

### 1. User-Agentの設定
松井証券のサイトは403エラーを返す可能性があるため、以下の対策を実施：
```python
headers = {
    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
}
```

### 2. リトライロジック
- 初回失敗時: 5秒待機後リトライ
- 2回目失敗時: 10秒待機後リトライ
- 3回目失敗時: エラー通知して終了

### 3. 礼儀正しいアクセス
- 同一時刻に1回のみアクセス
- 過度なリクエストを避ける

## データ形式

### JSON構造例
```json
{
  "datetime": "20251020_0915",
  "url": "https://finance.matsui.co.jp/ranking-day-trading-morning/index?condition=0&market=0",
  "scraped_at": "2025-10-20T09:15:03+09:00",
  "rankings": [
    {
      "rank": "1",
      "code": "1234",
      "name": "サンプル株式会社",
      "price": "1,234",
      "change": "+56",
      "change_percent": "+4.76%",
      "volume": "12,345,678",
      "value": "1,234,567,890"
    }
  ]
}
```

## 制約事項

1. **HTML構造依存**: ページのHTML構造が変更された場合、スクリプトの修正が必要
2. **アクセス制限**: 松井証券側でアクセス制限が強化された場合、動作しなくなる可能性がある
3. **通知上限**: LINE Notify・Messaging API いずれも送信上限に注意
4. **実行時刻精度**: GitHub Actionsのcronは数分の遅延が発生する可能性がある

## 今後の拡張可能性

1. **データ分析機能**: 蓄積データからトレンドを分析
2. **差分通知**: 前回からの順位変動を通知
3. **グラフ化**: ランキング推移の可視化
4. **他の通知手段**: Slack、Discord等への対応
5. **CSV出力**: データ分析用にCSV形式でもエクスポート
