# セクター別騰落ランキング スクレイピング実装計画

## 概要

**目的**: 株探のセクター別騰落ランキングから、前日比が高い順/低い順のベスト5を取得し、LINE通知する

**ターゲットURL**: `https://kabutan.jp/warning/?mode=9_1`

**実行タイミング**:
- 12:00（昼休み、午前中の動向確認）
- 16:00（大引け後、1日の最終結果確認）

## 取得データ

### 必要な情報
1. **セクター名**（業種名）: 例）非鉄金属、電気機器、医薬品など
2. **前日比（%）**: 例）+3.06%、-2.45%

### 出力形式
**上昇ベスト5（前日比が高い順）:**
```
1位: 非鉄金属 +3.06%
2位: 電気機器 +2.85%
3位: 輸送用機器 +2.31%
4位: 機械 +1.98%
5位: 化学 +1.76%
```

**下落ベスト5（前日比が低い順）:**
```
1位: 銀行業 -2.34%
2位: 保険業 -1.98%
3位: その他金融業 -1.67%
4位: 海運業 -1.45%
5位: 鉱業 -1.23%
```

## HTML構造分析

### ページ構造
- **URL**: `https://kabutan.jp/warning/?mode=9_1`
- デフォルトで前日比降順（高い順）にソートされている
- ページネーションあり（15件/30件/50件表示切替可能）

### テーブル構造
```html
<table class="stock_kabuka_dwm">
  <thead>
    <tr>
      <th>コード</th>
      <th>銘柄名</th> <!-- セクター名 -->
      <th>銘柄数</th>
      <th>株価</th>
      <th colspan="2">前日比</th> <!-- +90.65と+3.06%の2列 -->
      <th>ＰＥＲ</th>
      <th>ＰＢＲ</th>
      <th>利回り</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="/stock/?code=0263">0263</a></td>
      <th><a href="/themes/?industry=13&market=1">非鉄金属</a></th>
      <td>21</td>
      <td>3,057.03</td>
      <td><span class="up">+90.65</span></td>
      <td><span class="up">+3.06</span>%</td>
      <td>...</td>
    </tr>
  </tbody>
</table>
```

### データ抽出のポイント

1. **セクター名**: `<th scope="row" class="tal"><a>` 内のテキスト
2. **銘柄数**: セクター名の次の `<td>` のテキスト
3. **前日比（円）**: `<td class="w61"><span class="up/down">` 内のテキスト
4. **前日比（%）**: `<td class="w50"><span class="up/down">` 内のテキスト（%記号付き）
5. **上昇/下落**: `class="up"` が上昇、`class="down"` が下落

## 実装方針

### ファイル構成

```
src/
├── scrape_sector_ranking.py  # 新規: セクター別ランキングスクレイピング
├── notify_sector_line.py     # 新規: セクター別ランキング用LINE通知（またはnotify_line.pyを拡張）
├── config.py                 # 既存: URLやスケジュール追加
└── check_workday.py          # 既存: 営業日判定（共通利用）

data/
└── sector/                    # 新規: セクター別ランキングデータ保存
    └── ranking_YYYYMMDD_HHMM.json
```

### スクレイピング処理フロー

1. **営業日チェック**: `check_workday.py` で土日祝を除外
2. **時間帯判定**: 現在時刻が 12:00±15分 または 16:00±15分 かチェック
3. **HTTP GET**: `https://kabutan.jp/warning/?mode=9_1` を取得
4. **HTML解析**: BeautifulSoupで `<table class="stock_kabuka_dwm">` を探す
5. **データ抽出**:
   - 全セクターの前日比（%）を取得
   - 前日比で降順ソート → 上位5件
   - 前日比で昇順ソート → 下位5件
6. **JSON保存**: `data/sector/ranking_YYYYMMDD_HHMM.json` に保存
7. **LINE通知**: フォーマットしたメッセージを送信

### データ形式（JSON）

```json
{
  "datetime": "20251027_1200",
  "url": "https://kabutan.jp/warning/?mode=9_1",
  "scraped_at": "2025-10-27T12:00:03+09:00",
  "sectors": [
    {
      "code": "0263",
      "name": "非鉄金属",
      "change_percent": "+3.06"
    },
    ...
  ],
  "top5": [
    {"name": "非鉄金属", "change_percent": "+3.06"},
    ...
  ],
  "bottom5": [
    {"name": "銀行業", "change_percent": "-2.34"},
    ...
  ]
}
```

### LINE通知メッセージフォーマット

**色表現について:**
- 🟢 **緑色**: 上昇（プラス）を示す
- 🔴 **赤色**: 下落（マイナス）を示す
- これは株価表示の一般的な慣例に従っています

```
📊 2025-10-27 12:00
セクター別騰落ランキング

【上昇TOP5】🟢
1位: 非鉄金属 +3.06%
2位: 電気機器 +2.85%
3位: 輸送用機器 +2.31%
4位: 機械 +1.98%
5位: 化学 +1.76%

【下落TOP5】🔴
1位: 銀行業 -2.34%
2位: 保険業 -1.98%
3位: その他金融業 -1.67%
4位: 海運業 -1.45%
5位: 鉱業 -1.23%

💡 資金流入: 非鉄金属、電気機器
💡 資金流出: 銀行業、保険業
```

## GitHub Actions設定

### ワークフロー修正

`.github/workflows/scrape_rankings.yml` に以下を追加：

```yaml
on:
  schedule:
    # 既存のcron（松井証券ランキング）
    - cron: '20 0 * * 1-5'  # JST 09:20
    - cron: '35 0 * * 1-5'  # JST 09:35
    - cron: '2 3 * * 1-5'   # JST 12:02
    - cron: '47 3 * * 1-5'  # JST 12:47
    - cron: '32 5 * * 1-5'  # JST 14:32

    # 新規追加（セクター別ランキング）
    - cron: '0 3 * * 1-5'   # JST 12:00 - セクター別ランキング
    - cron: '0 7 * * 1-5'   # JST 16:00 - セクター別ランキング

jobs:
  scrape:
    steps:
      - name: Run scraper
        run: |
          cd src
          python scrape_rankings.py          # 既存
          python scrape_sector_ranking.py    # 新規追加
```

### config.py 修正案

```python
# セクター別ランキング用URL
SECTOR_RANKING_URL = "https://kabutan.jp/warning/?mode=9_1"

# セクター別ランキング取得時刻（JST）
SECTOR_TIME_SLOTS = {
    "12:00": "midday",    # 昼休み
    "16:00": "closing"    # 大引け後
}

# データ保存ディレクトリ
SECTOR_DATA_DIR = Path(__file__).parent.parent / "data" / "sector"
```

## 実装の注意点

### 1. スクレイピング対策
- **User-Agent設定**: 既存の `config.USER_AGENT` を使用
- **リトライ処理**: 既存の `RETRY_COUNT`, `RETRY_DELAYS` を使用
- **レート制限**: 1リクエストのみなので問題なし

### 2. データの信頼性
- **ページ構造の変更**: 株探がHTML構造を変更する可能性あり
  - エラー時は適切なエラーメッセージをLINE通知
  - ログに詳細を記録
- **市場休場時**: 前日のデータが表示される可能性
  - 取得日時を必ず記録

### 3. エラーハンドリング
- **HTTP エラー**: 403, 500 などは既存のリトライ処理で対応
- **パースエラー**: テーブルが見つからない場合のエラー通知
- **データ異常**: セクター数が異常に少ない場合の警告

### 4. 通知の重複回避
- 松井証券ランキングとセクター別ランキングで通知時刻が近い場合
  - 12:02（松井）と 12:00（セクター）→ 2分差
  - メッセージで明確に区別できるようにする

## スケジュール統合案

### 現在の松井証券ランキング
- 09:20 - 午前中資金流入
- 09:35 - 午前中資金流入
- 12:02 - 午前中資金流入
- 12:47 - 午後資金流入
- 14:32 - 午後資金流入

### 新規セクター別ランキング
- **12:00** - セクター別騰落（昼休み）
- **16:00** - セクター別騰落（大引け後）

### 統合後の1日の流れ
```
09:20 📊 松井証券 午前中資金流入ランキング
09:35 📊 松井証券 午前中資金流入ランキング
12:00 📈 セクター別騰落ランキング（昼）← 新規
12:02 📊 松井証券 午前中資金流入ランキング
12:47 📊 松井証券 午後資金流入ランキング
14:32 📊 松井証券 午後資金流入ランキング
16:00 📈 セクター別騰落ランキング（大引け）← 新規
```

## 実装ステップ

### Phase 1: 基本スクレイピング機能
1. `scrape_sector_ranking.py` の作成
2. HTML解析・データ抽出ロジック
3. JSON保存機能
4. ローカルでのテスト

### Phase 2: LINE通知機能
1. `notify_sector_line.py` の作成（または既存を拡張）
2. メッセージフォーマット機能
3. 上昇TOP5/下落TOP5の表示
4. ローカルでのLINE通知テスト

### Phase 3: GitHub Actions統合
1. ワークフローファイル修正
2. cron設定追加
3. 動作確認（手動実行）
4. 本番運用開始

### Phase 4: 改善・拡張
1. エラーハンドリング強化
2. ログ出力の充実
3. データ蓄積による分析機能（将来的）

## 確認事項

### 実装前に確認すること
- [ ] セクター別ランキングのデータ形式は要件を満たしているか
- [ ] LINE通知のメッセージフォーマットは見やすいか
- [ ] 12:00と16:00のタイミングは適切か
- [ ] 既存の松井証券ランキングとの棲み分けは明確か

### 実装後に確認すること
- [ ] ローカルでスクレイピングが正常に動作するか
- [ ] JSON形式でデータが保存されるか
- [ ] LINE通知が正しく送信されるか
- [ ] エラー時の通知が適切か
- [ ] GitHub Actionsで自動実行されるか

## リスクと対策

| リスク | 対策 |
|--------|------|
| 株探のHTML構造変更 | エラー検知とLINE通知、ログ記録 |
| スクレイピングの規約違反 | robots.txt確認、適切なUser-Agent設定 |
| 過度なアクセス | 1日2回のみ、既存のリトライ処理を流用 |
| データの信頼性 | 取得日時を記録、異常値チェック |
| LINE通知の過多 | 必要最小限の情報に絞る |

## 既存システムへの改善提案

### 松井証券ランキング通知の色表現改善（将来的な検討事項）

現在の松井証券ランキング通知では株価変動率（`change_percent`）を表示していますが、色の区別はしていません。
セクター別ランキングと同様に、株価変動率にも色表現を追加することで視認性が向上します。

**改善案:**
```
1位: [285A] キオクシアホールディングス 🟢+11.94% 🔺↑1
2位: [9984] ソフトバンクグループ 🟢+3.37% 🔻↓1
3位: [6920] レーザーテック 🟢+3.90% -
```

**実装方法:**
- `src/notify_line.py` の `format_success_message` 関数内で `change_percent` の先頭が `+` なら 🟢、`-` なら 🔴 を追加
- 既存の絵文字（🔺🔻🆕）との組み合わせで情報過多にならないよう配慮

**Note:** この改善は別タスクとして扱い、セクター別ランキング実装後に検討することを推奨します。

## まとめ

- **目的**: セクター別の資金流入/流出を把握
- **頻度**: 1日2回（12:00, 16:00）
- **データ**: 上昇TOP5 + 下落TOP5
- **通知**: LINEで簡潔に表示（🟢緑=上昇、🔴赤=下落）
- **実装**: 既存システムとの統合、段階的に実装

この計画で実装を進めてよろしいでしょうか？
