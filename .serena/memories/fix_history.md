# 修正履歴

## 2025-10-24: LINE通知フォーマット改善と順位変動表示機能の実装

### ユーザーからの要望

1. ベスト10全件を表示してほしい（ベスト3のみだった）
2. 株価変動率を表示してほしい
3. 「✅ 成功」という表記は不要
4. 文言を「午前中資金流入」「午後資金流入」に変更
5. 銘柄コードを見やすく表示
6. ランキング変動がわかるようにしてほしい（↑↓のマークなど）
7. 朝の通知が来ない問題を修正

### 実装内容

#### 1. LINE通知メッセージの改善

**ファイル:** `src/notify_line.py`  
**関数:** `format_success_message()`

**主な変更:**
- ベスト3 → ベスト10全件表示
- 「✅ [成功]」 → 「📊」に変更
- 「朝ランキング」 → 「午前中資金流入ランキング」
- 「午後ランキング」 → 「午後資金流入ランキング」
- 銘柄表示: 「社名 (コード)」 → 「[コード] 社名」
- 株価変動率を各銘柄に追加表示

#### 2. 順位変動表示機能の追加

**新機能:**
```python
def load_previous_ranking(target: str) -> Optional[RankingList]:
    """前回保存されたランキングデータを読み込む"""
    # data/{morning|afternoon}/から最新のJSONファイルを読み込み
    # 前回のランキングデータを返す
```

**順位変動インジケーター:**
- 🔺↑N: 順位が上昇（Nは上昇幅）
  - 例: 前回5位 → 今回3位 = 🔺↑2
- 🔻↓N: 順位が下降（Nは下降幅）
  - 例: 前回2位 → 今回4位 = 🔻↓2
- -: 変動なし
  - 例: 前回3位 → 今回3位 = -
- 🆕NEW: 新規ランクイン
  - 例: 前回11位以下 → 今回10位以内 = 🆕NEW

**特別な配慮:**
- 初回実行時（前回データなし）は順位変動を非表示
- 理由: 全銘柄が「🆕NEW」と表示されるのを回避
- 09:17頃の最初の実行では前回データがない場合が多い

#### 3. GitHub Actions cron時刻の調整

**問題:** 朝の通知（09:15, 09:30）が来ない

**原因:** GitHub Actions cronのUTC 00:15, 00:30は混雑時間帯で実行がスキップされることがある

**対策:** cron時刻を数分ずらして混雑回避

**変更内容:**
```yaml
# .github/workflows/scrape_rankings.yml
schedule:
  - cron: '17 0 * * 1-5'  # JST 09:17 (was 00:15 = JST 09:15)
  - cron: '32 0 * * 1-5'  # JST 09:32 (was 00:30 = JST 09:30)
  - cron: '2 3 * * 1-5'   # JST 12:02 (was 03:00 = JST 12:00)
  - cron: '47 3 * * 1-5'  # JST 12:47 (was 03:45 = JST 12:45)
  - cron: '32 5 * * 1-5'  # JST 14:32 (was 05:30 = JST 14:30)
```

**既存の時刻判定ロジック:**
- ±15分の許容範囲があるため、上記の調整でも正常動作
- `get_current_time_slot()` 関数が最も近い時刻を選択

### 新しい通知メッセージの例

#### 前回データありの場合（09:32以降）
```
📊 2025-10-24 09:32
午前中資金流入ランキング

1位: [285A] キオクシアホールディングス +11.94% 🔺↑1
2位: [9984] ソフトバンクグループ +3.37% 🔻↓1
3位: [6920] レーザーテック +3.90% -
4位: [6857] アドバンテスト +3.23% 🔺↑1
5位: [3692] ＦＦＲＩセキュリティ +12.73% 🆕NEW
6位: [8035] 東京エレクトロン +3.28% 🔻↓2
7位: [5016] ＪＸ金属 +4.96% 🔺↑1
8位: [5803] フジクラ +2.77% 🔻↓2
9位: [6146] ディスコ +2.43% 🔻↓2
10位: [7711] 助川電気工業 +10.51% 🆕NEW
```

#### 前回データなしの場合（09:17初回実行）
```
📊 2025-10-24 09:17
午前中資金流入ランキング

1位: [285A] キオクシアホールディングス +11.94%
2位: [9984] ソフトバンクグループ +3.37%
3位: [6920] レーザーテック +3.90%
4位: [6857] アドバンテスト +3.23%
5位: [3692] ＦＦＲＩセキュリティ +12.73%
6位: [8035] 東京エレクトロン +3.28%
7位: [5016] ＪＸ金属 +4.96%
8位: [5803] フジクラ +2.77%
9位: [6146] ディスコ +2.43%
10位: [7711] 助川電気工業 +10.51%
```

### コミット情報

#### コミット1: LINE通知改善
- **ハッシュ:** ef7b307
- **メッセージ:** "fix: LINE通知をベスト10全件表示・株価変動率付きに改善"
- **変更ファイル:** src/notify_line.py

#### コミット2: GitHub Actions cron調整
- **ハッシュ:** e4b23c1
- **メッセージ:** "fix: GitHub Actions cron時刻を混雑回避のため調整"
- **変更ファイル:** .github/workflows/scrape_rankings.yml, CLAUDE.md

#### コミット3: 順位変動表示機能
- **ハッシュ:** b36cd08
- **メッセージ:** "feat: LINE通知に順位変動表示とメッセージ改善を実装"
- **変更ファイル:** src/notify_line.py, src/scrape_rankings.py

### テスト結果

すべてローカル環境でテスト済み:

1. ✅ ベスト10全件表示
2. ✅ 株価変動率表示
3. ✅ 銘柄コード表示位置変更
4. ✅ 順位変動インジケーター（🔺↑, 🔻↓, -, 🆕NEW）
5. ✅ 初回実行時の特別処理（変動非表示）
6. ✅ 前回ランキング読み込み機能

### 期待される効果

次回のスケジュール実行（2025-10-25または次の平日）から:

1. **朝の通知が届く**
   - 09:17, 09:32, 12:02の3回の朝ランキング通知
   - GitHub Actions cron混雑回避により実行信頼性向上

2. **完全な情報把握**
   - ベスト10全件で資金流入状況を完全把握
   - 株価変動率で各銘柄のパフォーマンスを確認

3. **トレンド把握**
   - 順位変動で市場トレンドの変化を即座に認識
   - 新規ランクイン銘柄（🆕NEW）で注目銘柄を発見

4. **視認性向上**
   - 絵文字による直感的な理解
   - 銘柄コードが前に来ることで検索しやすい

### 次回の確認ポイント

**次の平日（2025-10-25以降）の確認事項:**

1. **朝の通知が届くか**
   - 09:17頃、09:32頃、12:02頃の3回
   - 初回（09:17）は順位変動なし
   - 2回目以降（09:32, 12:02）は順位変動あり

2. **通知内容の確認**
   - ベスト10全件表示されているか
   - 株価変動率が表示されているか
   - 順位変動インジケーターが正しく表示されているか
   - 銘柄コードが [コード] 形式で表示されているか

3. **GitHub Actions実行履歴**
   - https://github.com/u1631223-lang/stock-market/actions
   - 5回の実行（09:17, 09:32, 12:02, 12:47, 14:32頃）が成功しているか

4. **データコミット**
   - data/morning/とdata/afternoon/に新しいJSONファイルがあるか
   - JSONファイルにrankingsが10件含まれているか

---

## 2025-10-22: GitHub Actions cron遅延対応の修正

### 問題の発覚

本番運用開始後、スケジュール実行時刻になってもLINE通知が届かない問題が発生。

### 調査結果

1. **GitHub Actionsは正常に実行されていた**
   - https://github.com/u1631223-lang/stock-market/actions で実行履歴を確認
   - すべての実行が成功（緑チェックマーク）
   - 例: 12:34 PM, 12:36 PM, 12:57 PM, 1:00 PMなどの実行履歴あり

2. **実行ログから根本原因を特定**
   - Run scraperステップのログ:
     ```
     [2025-10-22 12:36:16] [INFO] 現在時刻: 12:36 は取得対象の時間帯ではありません。処理をスキップします。
     ```
   - 12:45のスケジュールが12:36に実行されたが、時刻の完全一致判定のため処理がスキップされた

3. **GitHub Actions cronの特性**
   - cronスケジュールは必ずしも指定時刻ぴったりに実行されない
   - 数分～15分程度の遅延が一般的に発生する
   - 負荷状況により実行タイミングがずれる

### 修正内容

**ファイル:** `src/scrape_rankings.py`  
**関数:** `get_current_time_slot()`

#### 旧実装（問題あり）
```python
def get_current_time_slot() -> Optional[str]:
    """現在時刻が属する取得対象を判定する。"""
    now = datetime.datetime.now(JST)
    current_time = now.strftime("%H:%M")
    return TIME_SLOTS.get(current_time)  # 完全一致のみ
```

#### 新実装（修正後）
```python
def get_current_time_slot() -> Optional[str]:
    """現在時刻が属する取得対象を判定する。
    
    GitHub Actionsのcron実行には遅延が発生することがあるため、
    設定時刻の±15分以内であれば該当する時間帯として判定する。
    
    注意: 複数の時間帯が重なる場合は、最も近い時刻の時間帯を返す。
    """
    now = datetime.datetime.now(JST)
    
    best_match = None
    min_diff = float('inf')
    
    # 各TIME_SLOTに対して、最も近い時刻を探す
    for time_str, target in TIME_SLOTS.items():
        slot_hour, slot_minute = map(int, time_str.split(":"))
        slot_time = now.replace(hour=slot_hour, minute=slot_minute, second=0, microsecond=0)
        
        # 現在時刻との差分を計算
        time_diff = abs((now - slot_time).total_seconds())
        
        # ±15分（900秒）以内で、かつ最も近い時刻を選択
        if time_diff <= 900 and time_diff < min_diff:
            min_diff = time_diff
            best_match = (time_str, target)
    
    if best_match:
        time_str, target = best_match
        logger.info(f"現在時刻 {now.strftime('%H:%M')} は {time_str} の実行時間帯です（許容範囲: ±15分）")
        return target
    
    return None
```

### 改善ポイント

1. **時間範囲判定（±15分）**
   - 設定時刻から前後15分以内であれば該当する時間帯として認識
   - GitHub Actionsの遅延に十分対応できる範囲

2. **最も近い時刻を優先**
   - 09:22は09:15と09:30の両方の範囲内だが、09:15に近いので"morning (09:15)"として判定
   - 時間帯の重なりによる誤判定を防止

3. **実行時刻のログ記録**
   - どの設定時刻のスケジュールとして認識されたかをログに明記
   - トラブルシューティングが容易に

### コミット情報

- **コミットハッシュ:** 6c059cd
- **コミット日時:** 2025-10-22
- **コミットメッセージ:** "fix: GitHub Actions cron遅延に対応した時刻判定ロジックを実装"
